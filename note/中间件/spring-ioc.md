# æ­»ç£•Spring

## ä¸€ã€æ·±å…¥ç†è§£IOC

### 1. IOCç†è®º

è§£é‡Šæ§åˆ¶åè½¬å†…å®¹ï¼š

- **è°æ§åˆ¶è°ï¼š**ä¼ ç»Ÿæ¨¡å¼ç›´æ¥newå¯¹è±¡ï¼Œæˆ‘ç›´æ¥æ§åˆ¶å¯¹è±¡ï¼Œæœ‰äº†IOCåç›´æ¥ç”±IOCå®¹å™¨æä¾›ï¼ŒIOCå®¹å™¨æ§åˆ¶äº†å¯¹è±¡

- **ä¸ºä½•åè½¬ï¼š**ç›´æ¥newæ˜¯æ­£è½¬ï¼Œåˆ°IOCåå˜ä»åŸæœ¬çš„ä¸»åŠ¨åˆ°è¢«åŠ¨æ¥å—

### 2. å„ä¸ªç»„ä»¶

ClassPathXmlApplicationContext çš„ç±»ç»§æ‰¿ä½“ç³»ç»“æ„ï¼Œè™½ç„¶åªæœ‰ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å®ƒåŸºæœ¬ä¸ŠåŒ…å«äº† IoC ä½“ç³»ä¸­å¤§éƒ¨åˆ†çš„æ ¸å¿ƒç±»å’Œæ¥å£ã€‚

![ç»„ä»¶ç±»å›¾](asserts/b12d2b0775b788c80247c9a7363011b6)

#### 2.1 Resourceä½“ç³»

`org.springframework.core.io.Resource`ï¼Œå¯¹èµ„æºçš„æŠ½è±¡ã€‚å®ƒçš„æ¯ä¸€ä¸ªå®ç°ç±»éƒ½ä»£è¡¨äº†ä¸€ç§èµ„æºçš„è®¿é—®ç­–ç•¥ï¼Œå¦‚ ClassPathResourceã€RLResourceã€FileSystemResource  ç­‰ã€‚

![image-20210327215902999](asserts/image-20210327215902999.png)

##### 2.1.1 ResourceLoader ä½“ç³»
æœ‰äº†èµ„æºï¼Œå°±åº”è¯¥æœ‰èµ„æºåŠ è½½ï¼ŒSpring åˆ©ç”¨ org.springframework.core.io.ResourceLoader æ¥è¿›è¡Œç»Ÿä¸€èµ„æºåŠ è½½ï¼Œç±»å›¾å¦‚ä¸‹ï¼š

![image-20210327220041779](asserts/image-20210327220041779.png)

#### 2.2 BeanFactory ä½“ç³»
org.springframework.beans.factory.BeanFactoryï¼Œæ˜¯ä¸€ä¸ªéå¸¸çº¯ç²¹çš„ bean å®¹å™¨ï¼Œå®ƒæ˜¯ IoC å¿…å¤‡çš„æ•°æ®ç»“æ„ï¼Œå…¶ä¸­ BeanDefinition æ˜¯å®ƒçš„åŸºæœ¬ç»“æ„ã€‚BeanFactory å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªBeanDefinition map ï¼Œå¹¶å¯æ ¹æ® BeanDefinition çš„æè¿°è¿›è¡Œ bean çš„åˆ›å»ºå’Œç®¡ç†ã€‚

![image-20210327220406014](asserts/image-20210327220406014.png)

- BeanFactory æœ‰ä¸‰ä¸ªç›´æ¥å­ç±» ListableBeanFactoryã€HierarchicalBeanFactory å’Œ AutowireCapableBeanFactory ã€‚
- DefaultListableBeanFactory ä¸ºæœ€ç»ˆé»˜è®¤å®ç°ï¼Œå®ƒå®ç°äº†æ‰€æœ‰æ¥å£ã€‚


#### 2.3 BeanDefinition ä½“ç³»
org.springframework.beans.factory.config.BeanDefinition ï¼Œç”¨æ¥æè¿° Spring ä¸­çš„ Bean å¯¹è±¡ã€‚

<img src="asserts/image-20210327220507693.png" alt="image-20210327220507693" style="zoom:50%;" />

#### 2.4 BeanDefinitionReader ä½“ç³»
org.springframework.beans.factory.support.BeanDefinitionReader çš„ä½œç”¨æ˜¯è¯»å– Spring çš„é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶å°†å…¶è½¬æ¢æˆ Ioc å®¹å™¨å†…éƒ¨çš„æ•°æ®ç»“æ„ ï¼šBeanDefinition ã€‚

![image-20210327222232806](asserts/image-20210327222232806.png)

#### 2.5 ApplicationContext ä½“ç³»
org.springframework.context.ApplicationContext ï¼Œè¿™ä¸ªå°±æ˜¯å¤§åé¼é¼çš„ Spring å®¹å™¨ï¼Œå®ƒå«åšåº”ç”¨ä¸Šä¸‹æ–‡ï¼Œä¸æˆ‘ä»¬åº”ç”¨æ¯æ¯ç›¸å…³ã€‚å®ƒ**ç»§æ‰¿** BeanFactory ï¼Œæ‰€ä»¥å®ƒæ˜¯ BeanFactory çš„æ‰©å±•å‡çº§ç‰ˆï¼Œå¦‚æœBeanFactory æ˜¯å±Œä¸çš„è¯ï¼Œé‚£ä¹ˆ ApplicationContext åˆ™æ˜¯åå‰¯å…¶å®çš„é«˜å¯Œå¸…ã€‚ç”±äº ApplicationContext çš„ç»“æ„å°±å†³å®šäº†å®ƒä¸ BeanFactory çš„ä¸åŒï¼Œå…¶ä¸»è¦åŒºåˆ«æœ‰ï¼š

    ç»§æ‰¿ org.springframework.context.MessageSource æ¥å£ï¼Œæä¾›å›½é™…åŒ–çš„æ ‡å‡†è®¿é—®ç­–ç•¥ã€‚
    ç»§æ‰¿ org.springframework.context.ApplicationEventPublisher æ¥å£ï¼Œæä¾›å¼ºå¤§çš„äº‹ä»¶æœºåˆ¶ã€‚
    æ‰©å±• ResourceLoader ï¼Œå¯ä»¥ç”¨æ¥åŠ è½½å¤šç§ Resource ï¼Œå¯ä»¥çµæ´»è®¿é—®ä¸åŒçš„èµ„æºã€‚
    å¯¹ Web åº”ç”¨çš„æ”¯æŒã€‚

<img src="asserts/bfdcd6b07c6f5434ba01895efd174cdc-1616855097068" alt="ApplicationContext ç±»å›¾" style="zoom:67%;" />

## äºŒã€Spring ç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥

1. èŒèƒ½åˆ’åˆ†æ¸…æ¥šã€‚èµ„æºçš„å®šä¹‰å’Œèµ„æºçš„åŠ è½½åº”è¯¥è¦æœ‰ä¸€ä¸ªæ¸…æ™°çš„**ç•Œé™**ï¼›
2. ç»Ÿä¸€çš„æŠ½è±¡ã€‚ç»Ÿä¸€çš„èµ„æº**å®šä¹‰**å’Œèµ„æºåŠ è½½**ç­–ç•¥**ã€‚èµ„æºåŠ è½½åè¦è¿”å›ç»Ÿä¸€çš„æŠ½è±¡ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¦å¯¹èµ„æºè¿›è¡Œæ€æ ·çš„å¤„ç†ï¼Œåº”è¯¥ç”±æŠ½è±¡èµ„æºæ¥å£æ¥ç•Œå®šã€‚

### 1. ç»Ÿä¸€èµ„æºï¼šResource

`org.springframework.core.io.Resource` ä¸º Spring æ¡†æ¶æ‰€æœ‰èµ„æºçš„æŠ½è±¡å’Œè®¿é—®æ¥å£ï¼Œå®ƒç»§æ‰¿ `org.springframework.core.io.InputStreamSource`æ¥å£ã€‚ä½œä¸ºæ‰€æœ‰èµ„æºçš„ç»Ÿä¸€æŠ½è±¡ï¼ŒResource å®šä¹‰äº†ä¸€äº›é€šç”¨çš„æ–¹æ³•ï¼Œç”±å­ç±» `AbstractResource` æä¾›ç»Ÿä¸€çš„é»˜è®¤å®ç°ã€‚å…·ä½“çœ‹æºç çš„Resource å†…å®¹ã€‚

#### 1.1 ç±»ç»“æ„

<img src="asserts/image-20210327223415764.png" alt="image-20210327223415764" style="zoom:67%;" />



ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼ŒResource æ ¹æ®èµ„æºçš„ä¸åŒç±»å‹æä¾›ä¸åŒçš„å…·ä½“å®ç°ï¼Œå¦‚ä¸‹ï¼š

- FileSystemResource ï¼šå¯¹ `java.io.File` ç±»å‹èµ„æºçš„å°è£…ï¼Œåªè¦æ˜¯è·Ÿ File  æ‰“äº¤é“çš„ï¼ŒåŸºæœ¬ä¸Šä¸ FileSystemResource ä¹Ÿå¯ä»¥æ‰“äº¤é“ã€‚æ”¯æŒæ–‡ä»¶å’Œ URL çš„å½¢å¼ï¼Œå®ç° WritableResource  æ¥å£ï¼Œä¸”ä» Spring Framework 5.0 å¼€å§‹ï¼ŒFileSystemResource ä½¿ç”¨ NIO2 APIè¿›è¡Œè¯»/å†™äº¤äº’ã€‚
- ByteArrayResource ï¼šå¯¹å­—èŠ‚æ•°ç»„æä¾›çš„æ•°æ®çš„å°è£…ã€‚å¦‚æœé€šè¿‡ InputStream å½¢å¼è®¿é—®è¯¥ç±»å‹çš„èµ„æºï¼Œè¯¥å®ç°ä¼šæ ¹æ®å­—èŠ‚æ•°ç»„çš„æ•°æ®æ„é€ ä¸€ä¸ªç›¸åº”çš„ ByteArrayInputStreamã€‚
- UrlResource ï¼šå¯¹ `java.net.URL`ç±»å‹èµ„æºçš„å°è£…ã€‚å†…éƒ¨å§”æ´¾ URL è¿›è¡Œå…·ä½“çš„èµ„æºæ“ä½œã€‚
- ClassPathResource ï¼šclass path ç±»å‹èµ„æºçš„å®ç°ã€‚ä½¿ç”¨ç»™å®šçš„ ClassLoader æˆ–è€…ç»™å®šçš„ Class æ¥åŠ è½½èµ„æºã€‚
- InputStreamResource ï¼šå°†ç»™å®šçš„ InputStream ä½œä¸ºä¸€ç§èµ„æºçš„ Resource çš„å®ç°ç±»ã€‚

#### 1.2 AbstractResource

`org.springframework.core.io.AbstractResource` ï¼Œä¸º Resource æ¥å£çš„é»˜è®¤**æŠ½è±¡**å®ç°ã€‚å®ƒå®ç°äº† Resource æ¥å£çš„**å¤§éƒ¨åˆ†çš„å…¬å…±å®ç°**ï¼Œä½œä¸º Resource æ¥å£ä¸­çš„é‡ä¸­ä¹‹é‡ï¼Œå…¶å®šä¹‰æŸ¥çœ‹æºç å†…å®¹

å¦‚æœæˆ‘ä»¬æƒ³è¦å®ç°è‡ªå®šä¹‰çš„ Resource ï¼Œè®°ä½ä¸è¦å®ç° Resource æ¥å£ï¼Œè€Œåº”è¯¥ç»§æ‰¿ AbstractResource æŠ½è±¡ç±»ï¼Œç„¶åæ ¹æ®å½“å‰çš„å…·ä½“èµ„æºç‰¹æ€§è¦†ç›–ç›¸åº”çš„æ–¹æ³•å³å¯ã€‚

#### 1.3 å…¶ä»–å­ç±»

Resource çš„å­ç±»ï¼Œä¾‹å¦‚ FileSystemResourceã€ByteArrayResource ã€ClassPathResourceç­‰ç­‰çš„ä»£ç éå¸¸ç®€å•ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œè‡ªå·±å»ç ”ç©¶ã€‚

### 2. ç»Ÿä¸€èµ„æºå®šä½ï¼šResourceLoader

`org.springframework.core.io.ResourceLoader` ä¸º Spring èµ„æºåŠ è½½çš„ç»Ÿä¸€æŠ½è±¡ï¼Œå…·ä½“çš„èµ„æºåŠ è½½åˆ™ç”±ç›¸åº”çš„å®ç°ç±»æ¥å®Œæˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°† ResourceLoader ç§°ä½œä¸ºç»Ÿä¸€èµ„æºå®šä½å™¨ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼šResourceLoaderï¼Œå®šä¹‰èµ„æºåŠ è½½å™¨ï¼Œä¸»è¦åº”ç”¨äºæ ¹æ®ç»™å®šçš„èµ„æºæ–‡ä»¶åœ°å€ï¼Œè¿”å›å¯¹åº”çš„ Resource ã€‚

```java
public interface ResourceLoader {

	String CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX; // CLASSPATH URL å‰ç¼€ã€‚é»˜è®¤ä¸ºï¼š"classpath:"
    /**
    æ ¹æ®æ‰€æä¾›èµ„æºçš„è·¯å¾„ location è¿”å› Resource å®ä¾‹ï¼Œä½†æ˜¯å®ƒä¸ç¡®ä¿è¯¥ Resource ä¸€å®šå­˜åœ¨ï¼Œéœ€è¦è°ƒç”¨ Resource#exist() æ–¹æ³•æ¥åˆ¤æ–­ã€‚
    è¯¥æ–¹æ³•æ”¯æŒä»¥ä¸‹æ¨¡å¼çš„èµ„æºåŠ è½½ï¼š
        URLä½ç½®èµ„æºï¼Œå¦‚ "file:C:/test.dat" ã€‚
        ClassPathä½ç½®èµ„æºï¼Œå¦‚ "classpath:test.dat ã€‚
        ç›¸å¯¹è·¯å¾„èµ„æºï¼Œå¦‚ "WEB-INF/test.dat" ï¼Œæ­¤æ—¶è¿”å›çš„Resource å®ä¾‹ï¼Œæ ¹æ®å®ç°ä¸åŒè€Œä¸åŒã€‚
    è¯¥æ–¹æ³•çš„ä¸»è¦å®ç°æ˜¯åœ¨å…¶å­ç±» DefaultResourceLoader ä¸­å®ç°ï¼Œå…·ä½“è¿‡ç¨‹æˆ‘ä»¬åœ¨åˆ†æ DefaultResourceLoader æ—¶åšè¯¦ç»†è¯´æ˜ã€‚
    **/
	Resource getResource(String location);

	ClassLoader getClassLoader();

}
```

#### 2.1 å­ç±»ç»“æ„

<img src="asserts/image-20210327225101310.png" alt="image-20210327225101310" style="zoom:67%;" />

#### 2.2 DefaultResourceLoader

ä¸ AbstractResource ç›¸ä¼¼ï¼Œ`org.springframework.core.io.DefaultResourceLoader` æ˜¯ ResourceLoader çš„é»˜è®¤å®ç°ã€‚

##### 2.2.1 æ„é€ å‡½æ•°

##### 2.2.2 getResourceæ–¹æ³•

ResourceLoader ä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•ä¸º `#getResource(String location)` ï¼Œå®ƒæ ¹æ®æä¾›çš„ location è¿”å›ç›¸åº”çš„ Resource ã€‚è€Œ DefaultResourceLoader å¯¹è¯¥æ–¹æ³•æä¾›äº†**æ ¸å¿ƒå®ç°**ï¼ˆå› ä¸ºï¼Œå®ƒçš„ä¸¤ä¸ªå­ç±»éƒ½æ²¡æœ‰æä¾›è¦†ç›–è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥æ–­å®š ResourceLoader çš„èµ„æºåŠ è½½ç­–ç•¥å°±å°è£…åœ¨ DefaultResourceLoader ä¸­)ï¼Œè¯¦æƒ…çœ‹æºç å†…å®¹

è¿”å›ClassPathContextResourceæˆ–è€…FileUrlResourceæˆ–è€…UrlResourceæˆ–è€…ClassPathResource

æ¯ä¸ªå…¶å®æœ€å¤§çš„åŒºåˆ«å°±åœ¨äºè¯»å–æ–‡ä»¶çš„å†…å®¹ getInputStream

##### 2.2.3 ProtocolResolver

`org.springframework.core.io.ProtocolResolver` ï¼Œç”¨æˆ·è‡ªå®šä¹‰åè®®èµ„æºè§£å†³ç­–ç•¥ï¼Œä½œä¸º DefaultResourceLoader çš„ **SPI**ï¼šå®ƒå…è®¸ç”¨æˆ·è‡ªå®šä¹‰èµ„æºåŠ è½½åè®®ï¼Œè€Œä¸éœ€è¦ç»§æ‰¿ ResourceLoader çš„å­ç±»ã€‚
åœ¨ä»‹ç» Resource æ—¶ï¼Œæåˆ°å¦‚æœè¦å®ç°è‡ªå®šä¹‰ Resourceï¼Œæˆ‘ä»¬åªéœ€è¦ç»§æ‰¿ AbstractResource å³å¯ï¼Œæœ‰äº†  ProtocolResolver åï¼Œæˆ‘ä»¬ä¸éœ€è¦ç»§æ‰¿ DefaultResourceLoaderï¼Œæ”¹ä¸ºå®ç° ProtocolResolver æ¥å£ä¹Ÿå¯ä»¥å®ç°è‡ªå®šä¹‰çš„ ResourceLoaderã€‚

ProtocolResolver æ¥å£ï¼Œä»…æœ‰ä¸€ä¸ªæ–¹æ³• `Resource resolve(String location, ResourceLoader resourceLoader)` ã€‚

åœ¨ Spring ä¸­ä½ ä¼šå‘ç°è¯¥æ¥å£å¹¶æ²¡æœ‰å®ç°ç±»ï¼Œå®ƒéœ€è¦ç”¨æˆ·è‡ªå®šä¹‰ï¼Œè‡ªå®šä¹‰çš„ Resolver å¦‚ä½•åŠ å…¥ Spring ä½“ç³»å‘¢ï¼Ÿè°ƒç”¨ `DefaultResourceLoader#addProtocolResolver(ProtocolResolver)` æ–¹æ³•å³å¯ã€‚



#### 2.3 FileSystemResourceLoader

æˆ‘ä»¬çœ‹åˆ°ï¼Œå…¶å® DefaultResourceLoader å¯¹`#getResourceByPath(String)` æ–¹æ³•å¤„ç†å…¶å®ä¸æ˜¯å¾ˆæ°å½“ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `org.springframework.core.io.FileSystemResourceLoader` ã€‚å®ƒç»§æ‰¿ DefaultResourceLoader ï¼Œä¸”è¦†å†™äº† `#getResourceByPath(String)` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åœ¨defaultçš„getResourceæ—¶å€™æœ‰dï¼Œä½¿ä¹‹ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½èµ„æºå¹¶ä»¥ FileSystemResource ç±»å‹è¿”å›ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æƒ³è¦çš„èµ„æºç±»å‹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
@Override
protected Resource getResourceByPath(String path) {
	// æˆªå–é¦– /
	if (path.startsWith("/")) {
		path = path.substring(1);
	}
	// åˆ›å»º FileSystemContextResource ç±»å‹çš„èµ„æº
	return new FileSystemContextResource(path);
}
```

##### 2.3.1 FileSystemContextResource
FileSystemContextResource ï¼Œä¸º FileSystemResourceLoader çš„å†…éƒ¨ç±»ï¼Œå®ƒç»§æ‰¿ FileSystemResource ç±»ï¼Œå®ç° ContextResource æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * FileSystemResource that explicitly expresses a context-relative path
 * through implementing the ContextResource interface.
 */
private static class FileSystemContextResource extends FileSystemResource implements ContextResource {

	public FileSystemContextResource(String path) {
		super(path);
	}

	@Override
	public String getPathWithinContext() {
		return getPath();
	}
}
```

- åœ¨æ„é€ å™¨ä¸­ï¼Œä¹Ÿæ˜¯è°ƒç”¨ FileSystemResource çš„æ„é€ å‡½æ•°æ¥æ„é€  FileSystemResource çš„ã€‚
- ä¸ºä»€ä¹ˆè¦æœ‰ FileSystemContextResource ç±»çš„åŸå› æ˜¯ï¼Œå®ç° ContextResource æ¥å£ï¼Œå¹¶å®ç°å¯¹åº”çš„ `#getPathWithinContext()` æ¥å£æ–¹æ³•ã€‚

#### 2.4 ClassRelativeResourceLoader

`org.springframework.core.io.ClassRelativeResourceLoader` ï¼Œæ˜¯ DefaultResourceLoader çš„å¦ä¸€ä¸ªå­ç±»çš„å®ç°ã€‚å’Œ FileSystemResourceLoader ç±»ä¼¼ï¼Œåœ¨å®ç°ä»£ç çš„ç»“æ„ä¸Šç±»ä¼¼ï¼Œä¹Ÿæ˜¯è¦†å†™ `#getResourceByPath(String path)` æ–¹æ³•ï¼Œå¹¶è¿”å›å…¶å¯¹åº”çš„ ClassRelativeContextResource çš„èµ„æºç±»å‹ã€‚

ClassRelativeResourceLoader æ‰©å±•çš„åŠŸèƒ½æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç»™å®šçš„`class` æ‰€åœ¨åŒ…æˆ–è€…æ‰€åœ¨åŒ…çš„å­åŒ…ä¸‹åŠ è½½èµ„æºã€‚

```java
@RequestMapping(value="/index.html")
	public String loginPage() throws IOException {
		ResourceLoader resourceLoader=new ClassRelativeResourceLoader(this.getClass());
        // test.xmlæ˜¯æœ¬ç±»ä¸‹çš„ï¼Œå¦‚æœä½¿ç”¨/test.xmlé‡‡ç”¨ç»å¯¹è·¯åŠ²æŸ¥æ‰¾æ–¹å¼
        // å®é™…ä¸Šæ˜¯jdkè‡ªæœ‰çš„å†…å®¹ java.lang.Class#resolveNameååŠ©æŸ¥æ‰¾çš„
		Resource resource=resourceLoader.getResource("test.xml");
		System.out.println(resource.getFile().getPath());
		return "index";
	}   
```

å¯ä»¥æŸ¥çœ‹ClassRelativeResourceLoaderTestç±»

https://blog.csdn.net/seasonsbin/article/details/80914911

#### 2.5 ResourcePatternResolver
ResourceLoader çš„ Resource getResource(String location) æ–¹æ³•ï¼Œæ¯æ¬¡åªèƒ½æ ¹æ® location è¿”å›ä¸€ä¸ª Resource ã€‚å½“éœ€è¦åŠ è½½å¤šä¸ªèµ„æºæ—¶ï¼Œæˆ‘ä»¬é™¤äº†å¤šæ¬¡è°ƒç”¨ #getResource(String location) æ–¹æ³•å¤–ï¼Œåˆ«æ— ä»–æ³•ã€‚org.springframework.core.io.support.ResourcePatternResolver æ˜¯ ResourceLoader çš„æ‰©å±•ï¼Œå®ƒæ”¯æŒæ ¹æ®æŒ‡å®šçš„èµ„æºè·¯å¾„åŒ¹é…æ¨¡å¼æ¯æ¬¡è¿”å›å¤šä¸ª Resource å®ä¾‹ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```java
public interface ResourcePatternResolver extends ResourceLoader {

	String CLASSPATH_ALL_URL_PREFIX = "classpath*:";

	Resource[] getResources(String locationPattern) throws IOException;

}
```

- ResourcePatternResolver åœ¨ ResourceLoader çš„åŸºç¡€ä¸Šå¢åŠ äº† `#getResources(String locationPattern)` æ–¹æ³•ï¼Œä»¥æ”¯æŒæ ¹æ®è·¯å¾„åŒ¹é…æ¨¡å¼è¿”å›**å¤šä¸ª** Resource å®ä¾‹ã€‚
- åŒæ—¶ï¼Œä¹Ÿæ–°å¢äº†ä¸€ç§**æ–°çš„åè®®**å‰ç¼€ `"classpath*:"`ï¼Œè¯¥åè®®å‰ç¼€ç”±å…¶å­ç±»è´Ÿè´£å®ç°ã€‚

#### 2.6 PathMatchingResourcePatternResolver

`org.springframework.core.io.support.PathMatchingResourcePatternResolver` ï¼Œä¸º ResourcePatternResolver æœ€å¸¸ç”¨çš„å­ç±»ï¼Œå®ƒé™¤äº†æ”¯æŒ ResourceLoader å’Œ ResourcePatternResolver æ–°å¢çš„ `"classpath*:"` å‰ç¼€å¤–ï¼Œ**è¿˜æ”¯æŒ Ant é£æ ¼çš„è·¯å¾„åŒ¹é…æ¨¡å¼**ï¼ˆç±»ä¼¼äº `"**/*.xml"`ï¼‰ã€‚

##### 2.6.1 æ„é€ å‡½æ•°

```java
/**
 * å†…ç½®çš„ ResourceLoader èµ„æºå®šä½å™¨
 */
private final ResourceLoader resourceLoader;
/**
 * Ant è·¯å¾„åŒ¹é…å™¨
 */
private PathMatcher pathMatcher = new AntPathMatcher();

public PathMatchingResourcePatternResolver() {
	this.resourceLoader = new DefaultResourceLoader();
}

public PathMatchingResourcePatternResolver(ResourceLoader resourceLoader) {
	Assert.notNull(resourceLoader, "ResourceLoader must not be null");
	this.resourceLoader = resourceLoader;
}

public PathMatchingResourcePatternResolver(@Nullable ClassLoader classLoader) {
	this.resourceLoader = new DefaultResourceLoader(classLoader);
}
```

- PathMatchingResourcePatternResolver åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ª ResourceLoaderï¼Œå¦‚æœä¸æŒ‡å®šçš„è¯ï¼Œå®ƒä¼šåœ¨å†…éƒ¨æ„é€ ä¸€ä¸ª DefaultResourceLoader ã€‚
- `pathMatcher` å±æ€§ï¼Œé»˜è®¤ä¸º AntPathMatcher å¯¹è±¡ï¼Œç”¨äºæ”¯æŒ Ant ç±»å‹çš„è·¯å¾„åŒ¹é…ã€‚

##### 2.6.2 getResource

```java
@Override
public Resource getResource(String location) {
	return getResourceLoader().getResource(location);
}

public ResourceLoader getResourceLoader() {
	return this.resourceLoader;
}
```

è¯¥æ–¹æ³•ï¼Œç›´æ¥å§”æ‰˜ç»™ç›¸åº”çš„ ResourceLoader æ¥å®ç°ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å®ä¾‹åŒ–çš„  PathMatchingResourcePatternResolver çš„æ—¶å€™ï¼Œå¦‚æœæœªæŒ‡å®š ResourceLoader  å‚æ•°çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆåœ¨åŠ è½½èµ„æºæ—¶ï¼Œå…¶å®å°±æ˜¯ DefaultResourceLoader çš„è¿‡ç¨‹ã€‚

å…¶å®åœ¨ä¸‹é¢ä»‹ç»çš„ `Resource[] getResources(String locationPattern)` æ–¹æ³•ä¹Ÿç›¸åŒï¼Œåªä¸è¿‡è¿”å›çš„èµ„æºæ˜¯**å¤šä¸ª**è€Œå·²ã€‚

```java
@Override
public Resource[] getResources(String locationPattern) throws IOException {
    Assert.notNull(locationPattern, "Location pattern must not be null");
    // ä»¥ "classpath*:" å¼€å¤´
    if (locationPattern.startsWith(CLASSPATH_ALL_URL_PREFIX)) {
        // è·¯å¾„åŒ…å«é€šé…ç¬¦
        // a class path resource (multiple resources for same name possible)
        if (getPathMatcher().isPattern(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()))) {
            // a class path resource pattern
            return findPathMatchingResources(locationPattern);
        // è·¯å¾„ä¸åŒ…å«é€šé…ç¬¦
        } else {
            // all class path resources with the given name
            return findAllClassPathResources(locationPattern.substring(CLASSPATH_ALL_URL_PREFIX.length()));
        }
    // ä¸ä»¥ "classpath*:" å¼€å¤´
    } else {
        // Generally only look for a pattern after a prefix here, // é€šå¸¸åªåœ¨è¿™é‡Œçš„å‰ç¼€åé¢æŸ¥æ‰¾æ¨¡å¼
        // and on Tomcat only after the "*/" separator for its "war:" protocol. è€Œåœ¨ Tomcat ä¸Šåªæœ‰åœ¨ â€œ*/ â€åˆ†éš”ç¬¦ä¹‹åæ‰ä¸ºå…¶ â€œwar:â€ åè®®
        int prefixEnd = (locationPattern.startsWith("war:") ? locationPattern.indexOf("*/") + 1 :
                locationPattern.indexOf(':') + 1);
        // è·¯å¾„åŒ…å«é€šé…ç¬¦
        if (getPathMatcher().isPattern(locationPattern.substring(prefixEnd))) {
            // a file pattern
            return findPathMatchingResources(locationPattern);
        // è·¯å¾„ä¸åŒ…å«é€šé…ç¬¦
        } else {
            // a single resource with the given name
            return new Resource[] {getResourceLoader().getResource(locationPattern)};
        }
    }
}
```

- **é** `"classpath*:"` å¼€å¤´ï¼Œä¸”è·¯å¾„**ä¸åŒ…å«**é€šé…ç¬¦ï¼Œç›´æ¥å§”æ‰˜ç»™ç›¸åº”çš„ ResourceLoader æ¥å®ç°ã€‚
- å…¶ä»–æƒ…å†µï¼Œè°ƒç”¨ `#findAllClassPathResources(...)`ã€æˆ– `#findPathMatchingResources(...)` æ–¹æ³•ï¼Œè¿”å›å¤šä¸ª Resource ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†åˆ†æã€‚

##### 2.6.3 findAllClassPathResources

å½“ `locationPattern` ä»¥ `"classpath*:"` å¼€å¤´ä½†æ˜¯ä¸åŒ…å«é€šé…ç¬¦ï¼Œåˆ™è°ƒç”¨ `#findAllClassPathResources(...)` æ–¹æ³•åŠ è½½èµ„æºã€‚è¯¥æ–¹æ³•è¿”å› classes è·¯å¾„ä¸‹å’Œæ‰€æœ‰ jar åŒ…ä¸­çš„æ‰€æœ‰ç›¸åŒ¹é…çš„èµ„æºã€‚

```java
protected Resource[] findAllClassPathResources(String location) throws IOException {
	String path = location;
	// å»é™¤é¦–ä¸ª /
	if (path.startsWith("/")) {
		path = path.substring(1);
	}
	// çœŸæ­£æ‰§è¡ŒåŠ è½½æ‰€æœ‰ classpath èµ„æº
	Set<Resource> result = doFindAllClassPathResources(path);
	if (logger.isTraceEnabled()) {
		logger.trace("Resolved classpath location [" + location + "] to resources " + result);
	}
	// è½¬æ¢æˆ Resource æ•°ç»„è¿”å›
	return result.toArray(new Resource[0]);
}
```

çœŸæ­£æ‰§è¡ŒåŠ è½½çš„æ˜¯åœ¨ `#doFindAllClassPathResources(...)` æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
protected Set<Resource> doFindAllClassPathResources(String path) throws IOException {
	Set<Resource> result = new LinkedHashSet<>(16);
	ClassLoader cl = getClassLoader();
	// <1> æ ¹æ® ClassLoader åŠ è½½è·¯å¾„ä¸‹çš„æ‰€æœ‰èµ„æº
	Enumeration<URL> resourceUrls = (cl != null ? cl.getResources(path) : ClassLoader.getSystemResources(path));
	// <2>
	while (resourceUrls.hasMoreElements()) {
		URL url = resourceUrls.nextElement();
		// å°† URL è½¬æ¢æˆ UrlResource
		result.add(convertClassLoaderURL(url));
	}
	// <3> åŠ è½½è·¯å¾„ä¸‹å¾—æ‰€æœ‰ jar åŒ…
	if ("".equals(path)) {
		// The above result is likely to be incomplete, i.e. only containing file system references.
		// We need to have pointers to each of the jar files on the classpath as well...
		addAllClassLoaderJarRoots(cl, result);
	}
	return result;
}
```

- <1> å¤„ï¼Œæ ¹æ® ClassLoader åŠ è½½è·¯å¾„ä¸‹çš„æ‰€æœ‰èµ„æºã€‚åœ¨åŠ è½½èµ„æºè¿‡ç¨‹æ—¶ï¼Œå¦‚æœåœ¨æ„é€  PathMatchingResourcePatternResolver å®ä¾‹çš„æ—¶å€™å¦‚æœä¼ å…¥äº† ClassLoaderï¼Œåˆ™è°ƒç”¨è¯¥ ClassLoader çš„ `#getResources()` æ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨ `ClassLoader#getSystemResources(path)` æ–¹æ³•ã€‚å¦å¤–ï¼Œ`ClassLoader#getResources()` æ–¹æ³•:

##### 2.6.4 findPathMatchingResources

å½“ `locationPattern` ä¸­åŒ…å«äº†**é€šé…ç¬¦**ï¼Œåˆ™è°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œèµ„æºåŠ è½½ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
protected Resource[] findPathMatchingResources(String locationPattern) throws IOException {
    // ç¡®å®šæ ¹è·¯å¾„ã€å­è·¯å¾„
    String rootDirPath = determineRootDir(locationPattern);
    String subPattern = locationPattern.substring(rootDirPath.length());
    // è·å–æ ¹æ®è·¯å¾„ä¸‹çš„èµ„æº
    Resource[] rootDirResources = getResources(rootDirPath);
    // éå†ï¼Œè¿­ä»£
    Set<Resource> result = new LinkedHashSet<>(16);
    for (Resource rootDirResource : rootDirResources) {
        rootDirResource = resolveRootDirResource(rootDirResource);
        URL rootDirUrl = rootDirResource.getURL();
        // bundle èµ„æºç±»å‹
        if (equinoxResolveMethod != null && rootDirUrl.getProtocol().startsWith("bundle")) {
            URL resolvedUrl = (URL) ReflectionUtils.invokeMethod(equinoxResolveMethod, null, rootDirUrl);
            if (resolvedUrl != null) {
                rootDirUrl = resolvedUrl;
            }
            rootDirResource = new UrlResource(rootDirUrl);
        }
        // vfs èµ„æºç±»å‹
        if (rootDirUrl.getProtocol().startsWith(ResourceUtils.URL_PROTOCOL_VFS)) {
            result.addAll(VfsResourceMatchingDelegate.findMatchingResources(rootDirUrl, subPattern, getPathMatcher()));
        // jar èµ„æºç±»å‹
        } else if (ResourceUtils.isJarURL(rootDirUrl) || isJarResource(rootDirResource)) {
            result.addAll(doFindPathMatchingJarResources(rootDirResource, rootDirUrl, subPattern));
        // å…¶å®ƒèµ„æºç±»å‹
        } else {
            result.addAll(doFindPathMatchingFileResources(rootDirResource, subPattern));
        }
    }
    if (logger.isTraceEnabled()) {
        logger.trace("Resolved location pattern [" + locationPattern + "] to resources " + result);
    }
    // è½¬æ¢æˆ Resource æ•°ç»„è¿”å›
    return result.toArray(new Resource[0]);
}
```

###### 2.6.4.1 determineRootDir

`determineRootDir(String location)` æ–¹æ³•ï¼Œä¸»è¦æ˜¯ç”¨äºç¡®å®šæ ¹è·¯å¾„ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * Determine the root directory for the given location.
 * <p>Used for determining the starting point for file matching,
 * resolving the root directory location to a {@code java.io.File}
 * and passing it into {@code retrieveMatchingFiles}, with the
 * remainder of the location as pattern.
 * <p>Will return "/WEB-INF/" for the pattern "/WEB-INF/*.xml",
 * for example.
 * @param location the location to check
 * @return the part of the location that denotes the root directory
 * @see #retrieveMatchingFiles
 */
protected String determineRootDir(String location) {
	// æ‰¾åˆ°å†’å·çš„åä¸€ä½
	int prefixEnd = location.indexOf(':') + 1;
	// æ ¹ç›®å½•ç»“æŸä½ç½®
	int rootDirEnd = location.length();
	// åœ¨ä»å†’å·å¼€å§‹åˆ°æœ€åçš„å­—ç¬¦ä¸²ä¸­ï¼Œå¾ªç¯åˆ¤æ–­æ˜¯å¦åŒ…å«é€šé…ç¬¦ï¼Œå¦‚æœåŒ…å«ï¼Œåˆ™æˆªæ–­æœ€åä¸€ä¸ªç”±â€/â€åˆ†å‰²çš„éƒ¨åˆ†ã€‚
	// ä¾‹å¦‚ï¼šåœ¨æˆ‘ä»¬è·¯å¾„ä¸­ï¼Œå°±æ˜¯æœ€åçš„ap?-context.xmlè¿™ä¸€æ®µã€‚å†å¾ªç¯åˆ¤æ–­å‰©ä¸‹çš„éƒ¨åˆ†ï¼Œç›´åˆ°å‰©ä¸‹çš„è·¯å¾„ä¸­éƒ½ä¸åŒ…å«é€šé…ç¬¦ã€‚
	while (rootDirEnd > prefixEnd && getPathMatcher().isPattern(location.substring(prefixEnd, rootDirEnd))) {
		rootDirEnd = location.lastIndexOf('/', rootDirEnd - 2) + 1;
	}
	// å¦‚æœæŸ¥æ‰¾å®Œæˆåï¼ŒrootDirEnd = 0 äº†ï¼Œåˆ™å°†ä¹‹å‰èµ‹å€¼çš„ prefixEnd çš„å€¼èµ‹ç»™ rootDirEnd ï¼Œä¹Ÿå°±æ˜¯å†’å·çš„åä¸€ä½
	if (rootDirEnd == 0) {
		rootDirEnd = prefixEnd;
	}
	// æˆªå–æ ¹ç›®å½•
	return location.substring(0, rootDirEnd);
}
```

æ–¹æ³•æ¯”è¾ƒç»•ï¼Œæ•ˆæœå¦‚ä¸‹ç¤ºä¾‹ï¼š

|               åŸè·¯å¾„               |      ç¡®å®šæ ¹è·¯å¾„       |
| :--------------------------------: | :-------------------: |
| `classpath*:test/cc*/spring-*.xml` |  `classpath*:test/`   |
| `classpath*:test/aa/spring-*.xml`  | `classpath*:test/aa/` |

###### 2.6.4.2 doFindPathMatchingXXXResources
#doFindPathMatchingXXXResources(...) æ–¹æ³•ï¼Œæ˜¯ä¸ªæ³›æŒ‡ï¼Œä¸€å…±å¯¹åº”ä¸‰ä¸ªæ–¹æ³•ï¼š

    #doFindPathMatchingJarResources(rootDirResource, rootDirUrl, subPatter) æ–¹æ³•
    #doFindPathMatchingFileResources(rootDirResource, subPattern) æ–¹æ³•
    VfsResourceMatchingDelegate#findMatchingResources(rootDirUrl, subPattern, pathMatcher) æ–¹æ³•

å› ä¸ºæœ¬æ–‡é‡åœ¨åˆ†æ Spring ç»Ÿä¸€èµ„æºåŠ è½½ç­–ç•¥çš„æ•´ä½“æµç¨‹ã€‚ç›¸å¯¹æ¥è¯´ï¼Œä¸Šé¢å‡ ä¸ªæ–¹æ³•çš„ä»£ç é‡ä¼šæ¯”è¾ƒå¤šã€‚æ‰€ä»¥æœ¬æ–‡ä¸å†è¿½æº¯ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š

   https://www.cnblogs.com/question-sky/p/6959493.html ï¼Œä¸»è¦é’ˆå¯¹ #doFindPathMatchingJarResources(rootDirResource, rootDirUrl, subPatter) æ–¹æ³•ã€‚
    http://www.blogjava.net/DLevin/archive/2012/12/01/392337.html ï¼Œä¸»è¦é’ˆå¯¹ #doFindPathMatchingFileResources(rootDirResource, subPattern) æ–¹æ³•ã€‚
    http://www.coderli.com/spring-wildpath-parse/ ğŸ˜ˆ è²Œä¼¼æ²¡æœ‰ä¸‹

##### 2.6å°ç»“

        classpath*:è¡¨ç¤ºæŸ¥æ‰¾classpathè·¯å¾„ä¸‹çš„æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„èµ„æºï¼ŒåŒ…å«jarã€zipç­‰èµ„æºï¼›classpath:è¡¨ç¤ºä¼˜å…ˆåœ¨é¡¹ç›®çš„èµ„æºç›®å½•ä¸‹æŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°æ‰å»jarã€zipç­‰èµ„æºä¸­æŸ¥æ‰¾
    
        è¯¥ç±»å¯ä»¥å¸®åŠ©springæŸ¥æ‰¾åˆ°ç¬¦åˆant-styleæ ¼å¼çš„æ‰€æœ‰èµ„æºï¼Œæ‰€ä»¥å¯Œæœ‰å€Ÿé‰´æ„ä¹‰ã€‚é™„ï¼šant-styleæŒ‡çš„æ˜¯ç±»ä¼¼*/?æ­¤ç±»çš„åŒ¹é…å­—ç¬¦


### ä¸‰ã€IoC ä¹‹åŠ è½½ BeanDefinition








## SpringWeb

å…³äºinputæµå’Œouputæµåªèƒ½ä¸€æ¬¡çš„æ—¶å€™ï¼ŒæŠŠä»–ä¿å­˜èµ·æ¥ï¼Œç„¶ååç»­çš„getInputStremç­‰éƒ½ä»è¿™ä¸ªæ•°æ®èµ°